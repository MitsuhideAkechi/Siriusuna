# 时序电路
**时序电路包括所有不是组合电路的电路，输出不能简单根据当前输入确定，会包含环路，可能发生竞争等。**
## 锁存器
### 结构基础
- 交叉耦合反相器
- N种稳态的元件可以表示log N位信息，双稳态原件为1种，etc
- 对于双稳态，若Q已知，\~Q已知，因此虽然有两个节点，但只有一个信息，可以用任意一个。
- 没有控制状态的输入
### SR
- 结构：交叉耦合或非门
- 输入：S(set)、R(reset)
- 输出：Q、~Q
- R = S = 0时，输出保持初值不变；Set将Q置1，Reset将Q置0。
- 真值表：

| S   | R   | Q                | ~Q                |
| --- | --- | ---------------- | ----------------- |
| 0   | 0   | Q<sub>prev</sub> | ~Q<sub>prev</sub> |
| 1   | 0   | 1                | 0                 |
| 0   | 1   | 0                | 1                 |
| 1   | 1   | 0                | 0                 |
- 输出由S、R决定

### D
- 输入：
	- D(data)：控制下一个状态的值
	- CLK(clock)：控制状态发生改变的时间
- 输出：Q，~Q
- CLK = 0时，不透明，Q保持不变；CLK = 1时，透明，Q置为D。
- 优点：分离了内容与时间，知道了改变为什么、何时改变。

## 触发器
### D
- 组成：由反向时钟控制的两个背靠背D锁存器，一主一从
- 功能：D触发器在时钟上升沿（时钟沿）将D复制到Q（采样），在其余时间保持原有状态
- ***因此相比D锁存器，D锁存器在clk高电平时一直透明，D触发器仅在上升沿更新值。***

## 寄存器
- 组成：一个N位寄存器由共享一个公共CLK输入的N个触发器组成（寄存器所有位同时被更新）

## 总结：
- D锁存器是电平敏感的，D触发器是边沿触发的，锁存器又共享一个CLK信号的一排D触发器组成。

## 同步逻辑设计
### 同步时序电路
**包含环路的时序电路存在不良竞争或不稳定行为，设计师用*寄存器*来断开环路，转化为组合逻辑电路与寄存器的集合。**
#### 定义
- 输入：一组有限离散状态+时钟输入（上升沿表示电路状态发生改变的时间）
- 功能规范：当前状态与输入值的各种组合，输出和下一个状态的值
- 时序规范：传播延迟(t<sub>pcq</sub>)、最小延迟(t<sub>ccq</sub>)（***这两个从时钟沿开始计时***，是触发器的传播延迟与最小延迟）、孔径时间（时钟上升沿直到输出改变的时间以及建立时间t<sub>setup</sub>、保持时间t<sub>hold</sub>）-> 输入必须相对于时钟上升沿稳定。
#### 特点：寄存器+组合电路，环路有寄存器
#### 常见同步时序电路：有限状态机、流水线
#### 有限状态机
- 输入、输出：M个输入、N个输出、k位状态，还有1个时钟信号和1个复位信号
- 组成：寄存器、两个组合逻辑块：下一个状态逻辑和输出逻辑。
- 分类：
	- Moore：输出取决于当前状态
	- Mealy：输出取决于当前状态与当前输入
- 状态机的分解：将复杂的有限状态机分解为多个互相作用的较简单的状态机
![](IMG-20251213231414132.png)
#### 时序规范
##### 动态约束
同步时序电路驶入必须在时钟沿附近的建立和维持时间内保持稳定。
- 孔径时间（P83）：
	时钟沿到来前，输入必须在建立时间内保持稳定；时钟沿后，输入必须至少在保持时间内保持稳定。因此孔径时间是输入保持稳定的时间总和。
##### 系统时序
- T<sub>c</sub>是重复时钟信号的上升沿之间的时间。倒数*f*<sub>c</sub> = 1/T<sub>c</sub>为时钟频率。
- 建立时间约束(最大延迟约束)
	- t<sub>pd</sub> <= T<sub>c</sub> - (t<sub>pcq</sub> + t<sub>setup</sub>)
	- 取决于建立时间，限制两个寄存器之间组合逻辑的**最大延迟**
- 保持时间约束（最小延迟约束）
	- t<sub>cd</sub> >= t<sub>hold</sub> - t<sub>ccq</sub>
	- 可靠触发器满足t<sub>hold</sub> <= t<sub>ccq</sub>，因此背靠背连结组成寄存器的时候不会导致问题。事实上，触发器经常被设计成t<sub>hold</sub> = 0。但如果保持时间较长且当前不满足，可以尝试增加缓冲器
	- 限制两个寄存器之间，组合逻辑的**最小延迟**
##### 亚稳态
- 定义：触发器对孔径时间内变化的输入采样时，输出可能区禁止区域内0~V<sub>DD</sub>之间的电压。
- 分辨时间：输入在孔径时间外，则t<sub>res</sub> = t<sub>pcq</sub>，否则比较长。在稳定到0或1前一直是一个亚稳定值，到稳态的时间无界。
##### 同步器
为了确保产生正确的逻辑电平，所有异步输入必须经过同步器。  

#### 并行
系统的速度可以用延迟和吞吐量度量。
- 概念：
	- 任务：经过处理后能产生输出的一组输入
	- 延迟：任务开始到结束所需的时间
	- 吞吐量：系统单位时间内完成的任务量
- 并行：
	- 空间并行：提供多个相同硬件，以便同时处理多个任务(超标量)
	- 时间并行：把一个任务分成多个阶段，每个时间内每部分都有一个不同任务正在处理，从而重叠处理任务（流水线）
- 效果：  
	- 延迟为L的任务，无并行则吞吐量为1/L；  
	- 若空间并行系统中有N个硬件，则吞吐量为N/L；  
	- 若时间并行系统中任务分步，最长延迟为L'，则吞吐量为L'/N。
- 依存关系：当前任务依赖于前一个任务的结果，则只有前一个任务完成后，后一个任务才能开始。